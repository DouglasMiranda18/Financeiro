<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HardKills eSports - Financeiro Coletivo</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Reset e estilos base */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Arial', sans-serif;
    }

    body {
      background-color: #121212;
      color: #ffffff;
      line-height: 1.6;
    }

    /* Container principal */
    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Cabeçalho */
    header {
      background-color: #000000;
      padding: 15px 0;
      border-bottom: 2px solid#f15d12;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
    }

    /* Código atualizado para cor verde */
    .logo h1 {
      color: #f15d12;
      /* Cor alterada para verde limão */
      margin-left: 10px;
      font-size: 24px;
    }

    .user-info {
      display: flex;
      align-items: center;
    }

    .user-info span {
      margin-right: 15px;
      color: #cccccc;
    }

    /* Navegação por abas */
    .tabs {
      display: flex;
      border-bottom: 1px solid #333;
      margin-bottom: 20px;
    }

    .tab-button {
      background: none;
      border: none;
      padding: 15px 20px;
      color: #cccccc;
      font-size: 16px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }

    .tab-button:hover {
      color: #ffffff;
    }

    .tab-button.active {
      color: #f15d12;
      border-bottom: 3px solid #f15d12;
    }

    /* Conteúdo das abas */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Cards de resumo */
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background-color: #1e1e1e;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .card-income {
      border-left: 4px solid #4CAF50;
    }

    .card-expense {
      border-left: 4px solid #F44336;
    }

    .card-balance {
      border-left: 4px solid #f15d12;
    }

    .card h3 {
      color: #999;
      font-size: 14px;
      text-transform: uppercase;
      margin-bottom: 10px;
    }

    .card .amount {
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .card-income .amount {
      color: #4CAF50;
    }

    .card-expense .amount {
      color: #F44336;
    }

    .card-balance .amount {
      color: #f15d12;
    }

    .card .change {
      font-size: 14px;
      color: #888;
    }

    /* Gráficos */
    .charts {
      display: flex;
      flex-wrap: wrap;
      /* Permite que os gráficos quebrem para a próxima linha */
      gap: 20px;
      margin-bottom: 30px;
    }

    .chart-container {
      background-color: #1e1e1e;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      /* Largura para ocupar metade da linha, com mínimo de 300px */
      width: calc(50% - 20px);
      min-width: 300px;
      height: 300px;
      flex-grow: 1;
      /* Permite que os itens cresçam para preencher o espaço disponível */
    }

    @media (max-width: 768px) {
      .chart-container {
        width: 100%;
        /* Em telas menores, ocupa a largura total */
      }
    }

    .chart-wrapper {
      position: relative;
      height: 85%;
      /* Deixa um pouco de espaço para o título h3 */
      width: 100%;
    }

    .chart-container h3 {
      color: #ffffff;
      margin-bottom: 15px;
      font-size: 18px;
    }

    /* Tabela de transações */
    .transactions-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
    }

    .transactions-table th {
      background-color: #1e1e1e;
      color: #999;
      text-align: left;
      padding: 12px 15px;
      font-size: 14px;
      text-transform: uppercase;
    }

    .transactions-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #333;
    }

    .transactions-table tr:hover {
      background-color: #1a1a1a;
    }

    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }

    .badge-income {
      background-color: rgba(76, 175, 80, 0.2);
      color: #4CAF50;
    }

    .badge-expense {
      background-color: rgba(244, 67, 54, 0.2);
      color: #F44336;
    }

    .amount-income {
      color: #4CAF50;
      font-weight: bold;
    }

    .amount-expense {
      color: #F44336;
      font-weight: bold;
    }

    /* Formulários */
    .form-container {
      background-color: #1e1e1e;
      border-radius: 8px;
      padding: 25px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      max-width: 600px;
      margin: 0 auto;
    }

    .form-title {
      color: #ffffff;
      margin-bottom: 20px;
      font-size: 20px;
      border-bottom: 1px solid #333;
      padding-bottom: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #cccccc;
    }

    .form-control {
      width: 100%;
      padding: 10px 15px;
      background-color: #2c2c2c;
      border: 1px solid #444;
      border-radius: 4px;
      color: #ffffff;
      font-size: 16px;
    }

    .form-control:focus {
      outline: none;
      border-color: #f15d12;
      box-shadow: 0 0 0 2px rgba(255, 165, 0, 0.2);
    }

    .radio-group {
      display: flex;
      gap: 20px;
    }

    .radio-label {
      display: flex;
      align-items: center;
      cursor: pointer;
    }

    .radio-label input {
      margin-right: 8px;
    }

    .btn {
      display: inline-block;
      padding: 10px 20px;
      background-color: #333;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
    }

    .btn-primary {
      background-color: #f15d12;
      color: #000000;
    }

    .btn-primary:hover {
      background-color: #f15d12;
    }

    .btn-danger {
      background-color: #F44336;
    }

    .btn-danger:hover {
      background-color: #D32F2F;
    }

    /* Filtros */
    .filters {
      background-color: #1e1e1e;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .filters-title {
      color: #ffffff;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .filters-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .filter-group {
      margin-bottom: 0;
    }

    .filters-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 15px;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background-color: #1e1e1e;
      border-radius: 8px;
      padding: 25px;
      width: 100%;
      max-width: 500px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #333;
    }

    .modal-title {
      color: #ffffff;
      font-size: 20px;
    }

    .modal-close {
      background: none;
      border: none;
      color: #999;
      font-size: 24px;
      cursor: pointer;
    }

    .modal-footer {
      display: flex;
      justify-content: space-between;
      margin-top: 25px;
      padding-top: 15px;
      border-top: 1px solid #333;
    }

    /* Login */
    .login-container {
      display: none;
      /* Inicia escondido */
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: linear-gradient(to bottom right, #000000, #1a1a1a);
    }

    .login-form {
      background-color: #1e1e1e;
      border-radius: 8px;
      padding: 30px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      border: 2px solid #f15d12;
      position: relative;
    }

    .login-form::before {
      content: '';
      position: absolute;
      top: -5px;
      left: -5px;
      width: 20px;
      height: 20px;
      border-top: 2px solid #f15d12;
      border-left: 2px solid #f15d12;
    }

    .login-form::after {
      content: '';
      position: absolute;
      bottom: -5px;
      right: -5px;
      width: 20px;
      height: 20px;
      border-bottom: 2px solid #f15d12;
      border-right: 2px solid #f15d12;
    }

    .login-logo {
      text-align: center;
      margin-bottom: 30px;
    }

    .login-logo h2 {
      color: #f15d12;
      font-size: 28px;
      margin-top: 15px;
      letter-spacing: 2px;
    }

    .login-logo p {
      color: #999;
      font-size: 14px;
    }

    .login-input {
      width: 100%;
      padding: 12px 15px;
      margin-bottom: 15px;
      background-color: #2c2c2c;
      border: 1px solid #444;
      border-radius: 4px;
      color: #ffffff;
      font-size: 16px;
    }

    .login-btn {
      width: 100%;
      padding: 12px;
      background-color: #f15d12;
      color: #000000;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin-bottom: 15px;
      transition: all 0.3s;
    }

    .login-btn:hover {
      background-color: #f15d12;
      box-shadow: 0 0 15px rgba(218, 105, 0, 0.5);
    }

    .login-google {
      width: 100%;
      padding: 12px;
      background-color: #2c2c2c;
      color: #ffffff;
      border: 1px solid #444;
      border-radius: 4px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .login-google img {
      margin-right: 10px;
      width: 18px;
      height: 18px;
    }

    .login-error {
      color: #F44336;
      text-align: center;
      margin-top: 15px;
      display: none;
    }

    /* Responsividade */
    @media (max-width: 768px) {
      .charts {
        grid-template-columns: 1fr;
      }

      .filters-form {
        grid-template-columns: 1fr;
      }

      .transactions-table {
        display: block;
        overflow-x: auto;
      }
    }

    /* Destaques */
    .highlights {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .highlight-card {
      background-color: #1e1e1e;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .highlight-card h3 {
      color: #ffffff;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .highlight-item {
      display: flex;
      justify-content: space-between;
      padding: 12px;
      background-color: #2c2c2c;
      border-radius: 4px;
      margin-bottom: 10px;
    }

    .highlight-item:last-child {
      margin-bottom: 0;
    }

    .highlight-info h4 {
      color: #ffffff;
      font-size: 16px;
      margin-bottom: 5px;
    }

    .highlight-info p {
      color: #999;
      font-size: 14px;
    }

    .highlight-amount {
      font-weight: bold;
      align-self: center;
    }

    .highlight-amount.income {
      color: #4CAF50;
    }

    .highlight-amount.expense {
      color: #F44336;
    }
  </style>
</head>

<body>
  <div id="loginPage" class="login-container">
    <div class="login-form">
      <div class="login-logo">
        <img src="1063368d-f11b-47b1-9ba3-afb08fe33885.png" alt="Logo HARDKILLS" width="80" height="80">
        <h2>HARDKILLS</h2>
        <p>ADMIN FINANCEIRO</p>
      </div>
      <form id="loginForm">
        <input type="email" id="email" class="login-input" placeholder="Email" required>
        <input type="password" id="password" class="login-input" placeholder="Senha" required>
        <button type="submit" class="login-btn">ENTRAR</button>
        <button type="button" id="googleLogin" class="login-google">
          <img
            src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTkgMy40OGMxLjY5IDAgMi44My43MyAzLjQ4IDEuMzRsLjY0LjYzLTIuNTMgMi41My0uMjMtLjMxQzEwLjA0IDcuMzQgOS41IDcuMDYgOSA3LjA2Yy0xLjMgMC0yLjM2IDEuMDYtMi4zNiAyLjM2IDAgMS4zIDEuMDYgMi4zNiAyLjM2IDIuMzYuNzggMCAxLjUzLS40OCAyLjA5LTEuMDNsLjMxLS4zMWgyLjQ3bC0uNjQgLjY0Yy0xLjA5IDEuMDktMi41MiAxLjY5LTQuMjMgMS42OS0zLjI1IDAtNS44OS0yLjY0LTUuODktNS44OUMzLjExIDMuNjQgNS43NSAxIDkgMXM1Ljg5IDIuNjQgNS44OSA1Ljg5YzAgLjQzLS4wNS44NS0uMTQgMS4yNkgzLjExYy4xNiAxLjUgMS40MSAyLjY4IDIuOTUgMi42OGguMDFjLjgxIDAgMS41NC0uMzMgMi4wOS0uODdsLjMxLS4zMSAyLjUzIDIuNTMtLjYzLjYzYy0xLjE4IDEuMTgtMi43OCAxLjgxLTQuMyAxLjgxLTMuNTEgMC02LjM2LTIuODYtNi4zNi02LjM2QzIuNjQgMy44NiA1LjQ5IDEgOSAxeiIgZmlsbD0iI2ZmZiIvPjwvc3ZnPg=="
            alt="Google">
          ENTRAR COM GOOGLE
        </button>
      </form>
      <div id="loginError" class="login-error"></div>
    </div>
  </div>


  <div id="dashboard" style="display: none;">
    <header>
      <div class="container">
        <div class="header-content">
          <div class="logo">
            <img src="1063368d-f11b-47b1-9ba3-afb08fe33885.png" alt="Logo HARDKILLS" width="32" height="32"
              viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
            <h1>HARDKILLS</h1>
          </div>
          <div class="user-info">
            <span id="userEmail"></span>
            <button id="logoutBtn" class="btn">Sair</button>
          </div>
        </div>
      </div>
    </header>

    <div class="container">
      <div class="tabs">
        <button id="dashboardTab" class="tab-button active">Dashboard</button>
        <button id="transactionsTab" class="tab-button">Transações</button>
        <button id="newTransactionTab" class="tab-button">Nova Transação</button>
      </div>

      <div id="dashboardContent" class="tab-content active">
        <div class="summary-cards">
          <div class="card card-income">
            <h3>Total Arrecadado</h3>
            <div class="amount">R$ <span id="totalIncome">0,00</span></div>
            <div class="change"><span>Valor total de entradas</span></div>
          </div>

          <div class="card card-expense">
            <h3>Total Gasto</h3>
            <div class="amount">R$ <span id="totalExpense">0,00</span></div>
            <div class="change"><span>Valor total de saídas</span></div>
          </div>

          <div class="card card-balance">
            <h3>Saldo Atual</h3>
            <div class="amount">R$ <span id="currentBalance">0,00</span></div>
            <div class="change"><span>Balanço financeiro total</span></div>
          </div>
        </div>

        <div class="charts">
          <div class="chart-container">
            <h3>Distribuição por Categoria (Saídas)</h3>
            <div class="chart-wrapper"> <canvas id="categoryChart"></canvas>
            </div>
          </div>

          <div class="chart-container">
            <h3>Entradas vs Saídas (Últimos 6 meses)</h3>
            <div class="chart-wrapper"> <canvas id="monthlyChart"></canvas>
            </div>
          </div>
        </div>

        <div class="highlights">
          <div class="highlight-card">
            <h3>Maiores Fontes de Receita</h3>
            <div id="topIncomes">
            </div>
          </div>

          <div class="highlight-card">
            <h3>Maiores Despesas</h3>
            <div id="topExpenses">
            </div>
          </div>
        </div>
      </div>

      <div id="transactionsContent" class="tab-content">
        <div class="filters">
          <h3 class="filters-title">Filtros</h3>
          <div class="filters-form">
            <div class="filter-group">
              <label for="filterType">Tipo</label>
              <select id="filterType" class="form-control">
                <option value="">Todos</option>
                <option value="income">Entrada</option>
                <option value="expense">Saída</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="filterCategory">Categoria</label>
              <select id="filterCategory" class="form-control">
                <option value="">Todas</option>
                <option value="Patrocínio">Patrocínio</option>
                <option value="Premiação">Premiação</option>
                <option value="Equipamentos">Equipamentos</option>
                <option value="Viagem">Viagem</option>
                <option value="Inscrição">Inscrição</option>
                <option value="Salários">Salários</option>
                <option value="Marketing">Marketing</option>
                <option value="Outros">Outros</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="filterStartDate">Data Inicial</label>
              <input type="date" id="filterStartDate" class="form-control">
            </div>
            <div class="filter-group">
              <label for="filterEndDate">Data Final</label>
              <input type="date" id="filterEndDate" class="form-control">
            </div>
          </div>
          <div class="filters-actions">
            <button id="applyFilters" class="btn btn-primary">Aplicar Filtros</button>
          </div>
        </div>

        <table class="transactions-table">
          <thead>
            <tr>
              <th>Data</th>
              <th>Tipo</th>
              <th>Categoria</th>
              <th>Descrição</th>
              <th>Valor</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="transactionsTable">
          </tbody>
        </table>
        <div id="noTransactions" style="display: none; text-align: center; padding: 20px; color: #999;">
          Nenhuma transação encontrada.
        </div>
      </div>

      <div id="newTransactionContent" class="tab-content">
        <div class="form-container">
          <h3 class="form-title">Nova Transação</h3>
          <form id="transactionForm">
            <div class="form-group">
              <label>Tipo</label>
              <div class="radio-group">
                <label class="radio-label">
                  <input type="radio" name="type" value="income" checked> Entrada
                </label>
                <label class="radio-label">
                  <input type="radio" name="type" value="expense"> Saída
                </label>
              </div>
            </div>

            <div class="form-group">
              <label for="transactionDate">Data</label>
              <input type="date" id="transactionDate" name="date" class="form-control" required>
            </div>

            <div class="form-group">
              <label for="transactionCategory">Categoria</label>
              <select id="transactionCategory" name="category" class="form-control" required>
                <option value="" disabled selected>Selecione uma categoria</option>
                <option value="Patrocínio">Patrocínio</option>
                <option value="Premiação">Premiação</option>
                <option value="Equipamentos">Equipamentos</option>
                <option value="Viagem">Viagem</option>
                <option value="Inscrição">Inscrição</option>
                <option value="Salários">Salários</option>
                <option value="Marketing">Marketing</option>
                <option value="Outros">Outros</option>
              </select>
            </div>

            <div class="form-group">
              <label for="transactionAmount">Valor (R$)</label>
              <input type="number" id="transactionAmount" name="amount" step="0.01" min="0" class="form-control"
                placeholder="0,00" required>
            </div>

            <div class="form-group">
              <label for="transactionDescription">Descrição</label>
              <textarea id="transactionDescription" name="description" rows="3" class="form-control"
                placeholder="Descreva a transação..."></textarea>
            </div>

            <div style="text-align: right;">
              <button type="submit" class="btn btn-primary">Salvar Transação</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Editar Transação</h3>
        <button id="closeEditModal" class="modal-close">&times;</button>
      </div>
      <form id="editTransactionForm">
        <input type="hidden" id="editTransactionId">
        <div class="form-group">
          <label>Tipo</label>
          <div class="radio-group">
            <label class="radio-label">
              <input type="radio" name="editType" value="income"> Entrada
            </label>
            <label class="radio-label">
              <input type="radio" name="editType" value="expense"> Saída
            </label>
          </div>
        </div>

        <div class="form-group">
          <label for="editTransactionDate">Data</label>
          <input type="date" id="editTransactionDate" name="editDate" class="form-control" required>
        </div>

        <div class="form-group">
          <label for="editTransactionCategory">Categoria</label>
          <select id="editTransactionCategory" name="editCategory" class="form-control" required>
            <option value="Patrocínio">Patrocínio</option>
            <option value="Premiação">Premiação</option>
            <option value="Equipamentos">Equipamentos</option>
            <option value="Viagem">Viagem</option>
            <option value="Inscrição">Inscrição</option>
            <option value="Salários">Salários</option>
            <option value="Marketing">Marketing</option>
            <option value="Outros">Outros</option>
          </select>
        </div>

        <div class="form-group">
          <label for="editTransactionAmount">Valor (R$)</label>
          <input type="number" id="editTransactionAmount" name="editAmount" step="0.01" min="0" class="form-control"
            required>
        </div>

        <div class="form-group">
          <label for="editTransactionDescription">Descrição</label>
          <textarea id="editTransactionDescription" name="editDescription" rows="3" class="form-control"></textarea>
        </div>

        <div class="modal-footer">
          <button type="button" id="deleteTransaction" class="btn btn-danger">Excluir</button>
          <button type="submit" class="btn btn-primary">Atualizar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="confirmationModal" class="modal">
    <div class="modal-content">
      <h3 class="modal-title" style="margin-bottom: 20px;">Confirmar Exclusão</h3>
      <p style="margin-bottom: 20px; color: #cccccc;">Tem certeza que deseja excluir esta transação? Esta ação não pode
        ser desfeita.</p>
      <div style="display: flex; justify-content: flex-end; gap: 10px;">
        <button id="cancelDelete" class="btn">Cancelar</button>
        <button id="confirmDelete" class="btn btn-danger">Excluir</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyC5s3aJYQcJ8F1u-bgbP0yjVu2If0ludm4",
      authDomain: "financeiro-53bcf.firebaseapp.com",
      projectId: "financeiro-53bcf",
      storageBucket: "financeiro-53bcf.appspot.com",
      messagingSenderId: "972002121771",
      appId: "1:972002121771:web:12de00b1262cf256d1b26e",
      measurementId: "G-RZ57WVP17B"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const googleProvider = new firebase.auth.GoogleAuthProvider();

    // --- Referência à coleção compartilhada ---
    const transactionsCollection = db.collection('shared_transactions');

    // Global variables
    let allTransactions = [];
    let filteredTransactions = [];
    let currentTransactionId = null;
    let unsubscribe = null;
    let categoryChartInstance = null;
    let monthlyChartInstance = null;

    // DOM Elements
    const loginPage = document.getElementById('loginPage');
    const dashboard = document.getElementById('dashboard');
    const loginForm = document.getElementById('loginForm');
    const loginError = document.getElementById('loginError');
    const logoutBtn = document.getElementById('logoutBtn');
    const userEmailEl = document.getElementById('userEmail');
    const googleLogin = document.getElementById('googleLogin');

    const dashboardTab = document.getElementById('dashboardTab');
    const transactionsTab = document.getElementById('transactionsTab');
    const newTransactionTab = document.getElementById('newTransactionTab');

    const dashboardContent = document.getElementById('dashboardContent');
    const transactionsContent = document.getElementById('transactionsContent');
    const newTransactionContent = document.getElementById('newTransactionContent');

    const transactionForm = document.getElementById('transactionForm');
    const transactionsTable = document.getElementById('transactionsTable');
    const noTransactions = document.getElementById('noTransactions');

    const editModal = document.getElementById('editModal');
    const closeEditModal = document.getElementById('closeEditModal');
    const editTransactionForm = document.getElementById('editTransactionForm');
    const deleteTransaction = document.getElementById('deleteTransaction');

    const confirmationModal = document.getElementById('confirmationModal');
    const cancelDelete = document.getElementById('cancelDelete');
    const confirmDelete = document.getElementById('confirmDelete');

    const filterType = document.getElementById('filterType');
    const filterCategory = document.getElementById('filterCategory');
    const filterStartDate = document.getElementById('filterStartDate');
    const filterEndDate = document.getElementById('filterEndDate');
    const applyFilters = document.getElementById('applyFilters');

    // --- FIREBASE AUTHENTICATION ---
    auth.onAuthStateChanged(user => {
      if (user) {
        // User is signed in: Mostra o dashboard
        loginPage.style.display = 'none';
        dashboard.style.display = 'block';
        userEmailEl.textContent = user.email;
        loadTransactions(); // Carrega os dados coletivos
      } else {
        // User is signed out: Mostra a página de login
        if (unsubscribe) {
          unsubscribe(); // Para de ouvir as atualizações do banco de dados
        }
        allTransactions = [];
        filteredTransactions = [];
        dashboard.style.display = 'none';
        loginPage.style.display = 'flex';
        loginForm.reset();
        loginError.style.display = 'none';
      }
    });

    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      loginError.style.display = 'none';

      auth.signInWithEmailAndPassword(email, password)
        .catch(error => {
          console.error("Login Error:", error);
          loginError.textContent = "Email ou senha inválidos.";
          loginError.style.display = 'block';
        });
    });

    googleLogin.addEventListener('click', () => {
      auth.signInWithPopup(googleProvider)
        .catch(error => {
          console.error("Google Login Error:", error);
          loginError.textContent = "Erro ao fazer login com Google.";
          loginError.style.display = 'block';
        });
    });

    logoutBtn.addEventListener('click', () => {
      auth.signOut();
    });

    // --- TAB NAVIGATION ---
    function setActiveTab(tab, content) {
      document.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      content.classList.add('active');

      if (content.id === 'dashboardContent') updateDashboard();
      if (content.id === 'transactionsContent') {
        applyTransactionFilters();
        renderTransactionsTable(filteredTransactions);
      }
    }

    dashboardTab.addEventListener('click', () => setActiveTab(dashboardTab, dashboardContent));
    transactionsTab.addEventListener('click', () => setActiveTab(transactionsTab, transactionsContent));
    newTransactionTab.addEventListener('click', () => {
      setActiveTab(newTransactionTab, newTransactionContent);
      document.getElementById('transactionDate').valueAsDate = new Date();
    });

    // --- FIRESTORE CRUD OPERATIONS ---
    function loadTransactions() {
      if (unsubscribe) unsubscribe();

      unsubscribe = transactionsCollection
        .orderBy("date", "desc")
        .onSnapshot(snapshot => {
          allTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          applyTransactionFilters();
          renderTransactionsTable(filteredTransactions);
          updateDashboard();
        }, error => {
          console.error("Error fetching transactions: ", error);
          alert("Não foi possível carregar os dados. Verifique as regras de segurança no Firebase.");
        });
    }

    // Add new transaction
    transactionForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const newTransaction = {
        type: document.querySelector('input[name="type"]:checked').value,
        date: document.getElementById('transactionDate').value,
        category: document.getElementById('transactionCategory').value,
        amount: parseFloat(document.getElementById('transactionAmount').value),
        description: document.getElementById('transactionDescription').value,
      };

      try {
        await transactionsCollection.add(newTransaction);
        transactionForm.reset();
        document.getElementById('transactionDate').valueAsDate = new Date();
        alert('Transação adicionada com sucesso!');
        setActiveTab(transactionsTab, transactionsContent);
      } catch (error) {
        console.error("Error adding transaction: ", error);
        alert('Erro ao adicionar transação.');
      }
    });

    function openEditModal(transactionId) {
      const transaction = allTransactions.find(t => t.id === transactionId);
      if (!transaction) return;

      currentTransactionId = transactionId;

      document.querySelector(`input[name="editType"][value="${transaction.type}"]`).checked = true;
      document.getElementById('editTransactionDate').value = transaction.date;
      document.getElementById('editTransactionCategory').value = transaction.category;
      document.getElementById('editTransactionAmount').value = transaction.amount;
      document.getElementById('editTransactionDescription').value = transaction.description;

      editModal.style.display = 'flex';
    }

    editTransactionForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentTransactionId) return;

      const updatedTransaction = {
        type: document.querySelector('input[name="editType"]:checked').value,
        date: document.getElementById('editTransactionDate').value,
        category: document.getElementById('editTransactionCategory').value,
        amount: parseFloat(document.getElementById('editTransactionAmount').value),
        description: document.getElementById('editTransactionDescription').value,
      };

      try {
        await transactionsCollection.doc(currentTransactionId).update(updatedTransaction);
        editModal.style.display = 'none';
        currentTransactionId = null;
        alert('Transação atualizada com sucesso!');
      } catch (error) {
        console.error("Error updating transaction: ", error);
        alert('Erro ao atualizar transação.');
      }
    });

    deleteTransaction.addEventListener('click', () => {
      if (!currentTransactionId) return;
      editModal.style.display = 'none';
      confirmationModal.style.display = 'flex';
    });

    cancelDelete.addEventListener('click', () => {
      confirmationModal.style.display = 'none';
      editModal.style.display = 'flex';
    });

    confirmDelete.addEventListener('click', async () => {
      if (!currentTransactionId) return;

      try {
        await transactionsCollection.doc(currentTransactionId).delete();
        confirmationModal.style.display = 'none';
        currentTransactionId = null;
        alert('Transação excluída com sucesso!');
      } catch (error) {
        console.error("Error deleting transaction: ", error);
        alert('Erro ao excluir transação.');
      }
    });

    // --- FILTERING AND RENDERING ---
    applyFilters.addEventListener('click', () => {
      applyTransactionFilters();
      renderTransactionsTable(filteredTransactions);
    });

    function applyTransactionFilters() {
      const typeFilter = filterType.value;
      const categoryFilter = filterCategory.value;
      const startDateFilter = filterStartDate.value;
      const endDateFilter = filterEndDate.value;

      filteredTransactions = allTransactions.filter(transaction => {
        if (typeFilter && transaction.type !== typeFilter) return false;
        if (categoryFilter && transaction.category !== categoryFilter) return false;
        if (startDateFilter && transaction.date < startDateFilter) return false;
        if (endDateFilter && transaction.date > endDateFilter) return false;
        return true;
      });
    }

    function renderTransactionsTable(transactions) {
      transactionsTable.innerHTML = '';

      if (transactions.length === 0) {
        noTransactions.style.display = 'block';
        return;
      }
      noTransactions.style.display = 'none';

      transactions.forEach(transaction => {
        const row = document.createElement('tr');

        const date = new Date(transaction.date + 'T00:00:00');
        const formattedDate = date.toLocaleDateString('pt-BR');
        const formattedAmount = transaction.amount.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        row.innerHTML = `
          <td>${formattedDate}</td>
          <td><span class="badge ${transaction.type === 'income' ? 'badge-income' : 'badge-expense'}">${transaction.type === 'income' ? 'Entrada' : 'Saída'}</span></td>
          <td>${transaction.category}</td>
          <td>${transaction.description}</td>
          <td class="${transaction.type === 'income' ? 'amount-income' : 'amount-expense'}">${formattedAmount}</td>
          <td><button class="btn edit-btn" data-id="${transaction.id}">Editar</button></td>
        `;
        transactionsTable.appendChild(row);
      });

      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function () {
          openEditModal(this.getAttribute('data-id'));
        });
      });
    }

    // --- DASHBOARD UPDATES ---
    function updateDashboard() {
      const totalIncome = allTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
      const totalExpense = allTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
      const balance = totalIncome - totalExpense;

      document.getElementById('totalIncome').textContent = totalIncome.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
      document.getElementById('totalExpense').textContent = totalExpense.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
      document.getElementById('currentBalance').textContent = balance.toLocaleString('pt-BR', { minimumFractionDigits: 2 });

      updateTopTransactions();
      updateCharts();
    }

    function updateTopTransactions() {
      const topIncomes = [...allTransactions].filter(t => t.type === 'income').sort((a, b) => b.amount - a.amount).slice(0, 3);
      const topExpenses = [...allTransactions].filter(t => t.type === 'expense').sort((a, b) => b.amount - a.amount).slice(0, 3);

      const topIncomesContainer = document.getElementById('topIncomes');
      topIncomesContainer.innerHTML = '';
      if (topIncomes.length === 0) {
        topIncomesContainer.innerHTML = '<p style="text-align: center; padding: 20px; color: #999;">Nenhuma entrada registrada.</p>';
      } else {
        topIncomes.forEach(income => {
          const item = document.createElement('div');
          item.className = 'highlight-item';
          item.innerHTML = `
                    <div class="highlight-info">
                        <h4>${income.description || 'Sem descrição'}</h4>
                        <p>${income.category}</p>
                    </div>
                    <div class="highlight-amount income">${income.amount.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</div>`;
          topIncomesContainer.appendChild(item);
        });
      }

      const topExpensesContainer = document.getElementById('topExpenses');
      topExpensesContainer.innerHTML = '';
      if (topExpenses.length === 0) {
        topExpensesContainer.innerHTML = '<p style="text-align: center; padding: 20px; color: #999;">Nenhuma saída registrada.</p>';
      } else {
        topExpenses.forEach(expense => {
          const item = document.createElement('div');
          item.className = 'highlight-item';
          item.innerHTML = `
                    <div class="highlight-info">
                        <h4>${expense.description || 'Sem descrição'}</h4>
                        <p>${expense.category}</p>
                    </div>
                    <div class="highlight-amount expense">${expense.amount.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</div>`;
          topExpensesContainer.appendChild(item);
        });
      }
    }

    function updateCharts() {
      const expenseByCategory = allTransactions
        .filter(t => t.type === 'expense')
        .reduce((acc, t) => {
          acc[t.category] = (acc[t.category] || 0) + t.amount;
          return acc;
        }, {});

      const categoryLabels = Object.keys(expenseByCategory);
      const categoryData = Object.values(expenseByCategory);

      const categoryCtx = document.getElementById('categoryChart').getContext('2d');
      if (categoryChartInstance) categoryChartInstance.destroy();
      categoryChartInstance = new Chart(categoryCtx, {
        type: 'pie',
        data: {
          labels: categoryLabels,
          datasets: [{
            label: 'Despesas por Categoria',
            data: categoryData,
            backgroundColor: ['#F44336', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5', '#2196F3', '#03A9F4', '#00BCD4'],
            borderColor: '#1e1e1e',
            borderWidth: 2
          }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#ffffff' } } } }
      });

      const monthlyData = { income: {}, expense: {} };
      const monthLabels = [];
      for (let i = 5; i >= 0; i--) {
        const d = new Date();
        d.setMonth(d.getMonth() - i);
        const monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        monthLabels.push(d.toLocaleString('pt-BR', { month: 'short', year: '2-digit' }));
        monthlyData.income[monthKey] = 0;
        monthlyData.expense[monthKey] = 0;
      }

      allTransactions.forEach(t => {
        const date = new Date(t.date + 'T00:00:00');
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        if (monthlyData[t.type] && monthKey in monthlyData[t.type]) {
          monthlyData[t.type][monthKey] += t.amount;
        }
      });

      const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
      if (monthlyChartInstance) monthlyChartInstance.destroy();
      monthlyChartInstance = new Chart(monthlyCtx, {
        type: 'bar',
        data: {
          labels: monthLabels,
          datasets: [
            { label: 'Entradas', data: Object.values(monthlyData.income), backgroundColor: 'rgba(76, 175, 80, 0.7)' },
            { label: 'Saídas', data: Object.values(monthlyData.expense), backgroundColor: 'rgba(244, 67, 54, 0.7)' }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          scales: {
            y: { ticks: { color: '#ccc' }, grid: { color: '#444' } },
            x: { ticks: { color: '#ccc' }, grid: { color: '#444' } }
          },
          plugins: { legend: { labels: { color: '#ffffff' } } }
        }
      });
    }

    // --- UTILITIES & INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('transactionDate').valueAsDate = new Date();
      const today = new Date();
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      document.getElementById('filterStartDate').value = thirtyDaysAgo.toISOString().split('T')[0];
      document.getElementById('filterEndDate').value = today.toISOString().split('T')[0];
    });

    window.addEventListener('click', (event) => {
      if (event.target === editModal) {
        editModal.style.display = 'none';
        currentTransactionId = null;
      }
      if (event.target === confirmationModal) {
        confirmationModal.style.display = 'none';
      }
    });

    closeEditModal.addEventListener('click', () => {
      editModal.style.display = 'none';
      currentTransactionId = null;
    });

    categoryChartInstance = new Chart(categoryCtx, {
      // ... outras configurações
      options: {
        responsive: true,
        maintainAspectRatio: false, // <--- Verifique esta linha
        plugins: { legend: { labels: { color: '#ffffff' } } }
      }
    });

    monthlyChartInstance = new Chart(monthlyCtx, {
      // ... outras configurações
      options: {
        responsive: true,
        maintainAspectRatio: false, // <--- Verifique esta linha
        scales: { /* ... */ },
        plugins: { legend: { labels: { color: '#ffffff' } } }
      }
    });

  </script>
</body>

</html>
